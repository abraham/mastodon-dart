name: Create Git Tag

on:
  workflow_dispatch:

jobs:
  create-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Extract version and create tag
        run: |
          PUBSPEC_FILE="packages/mastodon/pubspec.yaml"

          # Extract version from pubspec.yaml
          VERSION=$(grep "^version:" $PUBSPEC_FILE | sed 's/version: //')
          echo "Version: $VERSION"

          # Create tag with v prefix
          TAG_NAME="v${VERSION}"
          echo "Tag name: $TAG_NAME"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create and push tag
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"

          # Set output for summary
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        id: tag

      - name: Create summary
        run: |
          echo "## Git Tag Created ðŸ·ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.tag.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
